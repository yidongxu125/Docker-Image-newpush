name: 02. 双重同步 (Aliyun + GHCR)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "原镜像名称 (例如: mysql:8.0)"
        required: true
        default: "nginx:alpine"
      target_name:
        description: "保存名称 (可选，留空则自动处理)"
        required: false
      platform:
        description: "指定架构 (例如: linux/arm64，留空默认 amd64)"
        required: false
        default: ""
      force_sync:
        description: "强制同步 (跳过摘要比对)"
        type: boolean
        required: false
        default: false
      clean_disk:
        description: "清理磁盘空间 (减少空间不足风险，但耗时增加)"
        type: boolean
        required: false
        default: false

env:
  # 阿里云配置
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  # GHCR 配置
  GHCR_REGISTRY: ghcr.io
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
  # 映射 Secret 到 Env 以供 if 判断
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  double-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须赋予写 GHCR 的权限

    steps:
      # 1. 极致空间清理
      - name: 🗑️ 清理磁盘空间
        uses: easimon/maximize-build-space@master
        if: ${{ inputs.clean_disk == true }}
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          build-mount-path: "/var/lib/docker/"

      - name: 重启 Docker
        run: sudo service docker restart

      - name: 检查 Secrets
        run: |
          if [ -z "${{ secrets.ALIYUN_USERNAME }}" ] || [ -z "${{ secrets.ALIYUN_PASSWORD }}" ]; then
            echo "❌ 错误: 未配置 ALIYUN_USERNAME 或 ALIYUN_PASSWORDSecrets。"
            echo "请在 Settings -> Secrets and variables -> Actions 中配置。"
            exit 1
          fi

      # 2. 登录流程 (3方登录)
      - name: 登录 DockerHub (避免限流)
        if: env.DOCKERHUB_USER != ''
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: 登录阿里云
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: 登录 GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. 核心逻辑 (双向智能同步)
      - name: 执行双重同步
        env:
          INPUT_IMAGE: ${{ inputs.image_name }}
          INPUT_TARGET: ${{ inputs.target_name }}
          INPUT_PLATFORM: ${{ inputs.platform }}
          INPUT_FORCE: ${{ inputs.force_sync }}
        run: |
          # Define retry function
          # Define retry function
          function retry {
            local n=1
            local max=3
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "⚠️ Command failed. Attempt $n/$max:" >&2
                  sleep $delay;
                else
                  echo "❌ The command has failed after $max attempts." >&2
                  return 1
                fi
              }
            done
          }

          # --- A. 变量准备 ---
          SRC_IMAGE="$INPUT_IMAGE"
          PLATFORM_ARG=""
          # 默认架构参数供 Skopeo 使用
          SKOPEO_OS="linux"
          SKOPEO_ARCH="amd64"

          if [ -n "$INPUT_PLATFORM" ]; then
            PLATFORM_ARG="--platform $INPUT_PLATFORM"
            echo "⚙️ 指定架构: $INPUT_PLATFORM"
            
            # 解析 platform (例如 linux/arm64)
            if [[ "$INPUT_PLATFORM" == *"/"* ]]; then
               SKOPEO_OS=$(echo "$INPUT_PLATFORM" | awk -F'/' '{print $1}')
               SKOPEO_ARCH=$(echo "$INPUT_PLATFORM" | awk -F'/' '{print $2}')
            else
               SKOPEO_ARCH="$INPUT_PLATFORM"
            fi
          fi

          # 构造 Skopeo 参数：强制检查特定架构的摘要，避免 Manifest List 导致的误判
          SKOPEO_FLAGS="--override-os $SKOPEO_OS --override-arch $SKOPEO_ARCH"
          echo "🔍 Skopeo 检查模式: OS=$SKOPEO_OS, ARCH=$SKOPEO_ARCH"

          # --- B. 智能命名计算 ---
          if [ -n "$INPUT_TARGET" ]; then
            BASE_TAG="$INPUT_TARGET"
          else
             # 提取命名空间 (如 bitnami/nginx -> bitnami)
             SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
             NAME_ONLY=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
             
             if [ -n "$SCOPE" ]; then
                BASE_TAG="${SCOPE}_${NAME_ONLY}"
             else
                BASE_TAG="${NAME_ONLY}"
             fi
             
             # 多架构前缀
             if [ -n "$INPUT_PLATFORM" ]; then
                PLAT_PREFIX=$(echo "$INPUT_PLATFORM" | sed 's/\//_/g')
                BASE_TAG="${PLAT_PREFIX}_${BASE_TAG}"
             fi
          fi

          # 构造两个目标地址
          # 1. 阿里云地址
          ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$BASE_TAG"

          # 2. GHCR 地址 (强制小写)
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          TAG_LOWER=$(echo "$BASE_TAG" | tr '[:upper:]' '[:lower:]')
          GHCR_TARGET="$GHCR_REGISTRY/$OWNER_LOWER/$TAG_LOWER"

          echo "🎯 阿里云目标: $ALI_TARGET"
          echo "🎯 GHCR 目标: $GHCR_TARGET"

          # --- C. 智能摘要比对 (三方博弈) ---
          PUSH_ALI=true
          PUSH_GHCR=true

          if [ "$INPUT_FORCE" == "false" ]; then
             echo "🔍 开始比对 Digest & Created..."
             # 获取源信息
             SRC_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$SRC_IMAGE" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
             SRC_DIGEST=$(echo "$SRC_INFO" | cut -d'|' -f1)
             SRC_CREATED=$(echo "$SRC_INFO" | cut -d'|' -f2)
             
             # 获取阿里云信息
             ALI_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$ALI_TARGET" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
             ALI_DIGEST=$(echo "$ALI_INFO" | cut -d'|' -f1)
             ALI_CREATED=$(echo "$ALI_INFO" | cut -d'|' -f2)
             
             # 获取 GHCR 信息
             GHCR_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$GHCR_TARGET" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
             GHCR_DIGEST=$(echo "$GHCR_INFO" | cut -d'|' -f1)
             GHCR_CREATED=$(echo "$GHCR_INFO" | cut -d'|' -f2)

             echo "   源信息: $SRC_DIGEST ($SRC_CREATED)"
             echo "   阿里云: $ALI_DIGEST ($ALI_CREATED)"
             echo "   GHCR:   $GHCR_DIGEST ($GHCR_CREATED)"

             # 判断阿里云是否需要更新
             if [ -n "$SRC_DIGEST" ]; then
                 if [ "$SRC_DIGEST" == "$ALI_DIGEST" ]; then
                    echo "✅ 阿里云摘要一致，跳过。"
                    PUSH_ALI=false
                 elif [ -n "$ALI_DIGEST" ] && [ "$SRC_CREATED" == "$ALI_CREATED" ]; then
                    echo "⚠️ (Aliyun) 摘要不同但创建时间一致，跳过。"
                    PUSH_ALI=false
                 fi
             fi

             # 判断 GHCR 是否需要更新
             if [ -n "$SRC_DIGEST" ]; then
                 if [ "$SRC_DIGEST" == "$GHCR_DIGEST" ]; then
                    echo "✅ GHCR 摘要一致，跳过。"
                    PUSH_GHCR=false
                 elif [ -n "$GHCR_DIGEST" ] && [ "$SRC_CREATED" == "$GHCR_CREATED" ]; then
                    echo "⚠️ (GHCR) 摘要不同但创建时间一致，跳过。"
                    PUSH_GHCR=false
                 fi
             fi
          else
             echo "⚠️ 强制模式，跳过比对。"
          fi

          # --- D. 执行同步 ---
          # 只要有一方需要推，就需要拉取
          if [ "$PUSH_ALI" == "true" ] || [ "$PUSH_GHCR" == "true" ]; then
             echo "📥 正在拉取源镜像: $SRC_IMAGE"
             retry docker pull "$SRC_IMAGE" $PLATFORM_ARG

             # 1. 推送阿里云
             if [ "$PUSH_ALI" == "true" ]; then
                echo "🚀 推送阿里云..."
                docker tag $SRC_IMAGE $ALI_TARGET
                retry docker push "$ALI_TARGET"
                docker rmi $ALI_TARGET
             fi

             # 2. 推送 GHCR
             if [ "$PUSH_GHCR" == "true" ]; then
                echo "🚀 推送 GHCR..."
                docker tag $SRC_IMAGE $GHCR_TARGET
                retry docker push "$GHCR_TARGET"
                docker rmi $GHCR_TARGET
             fi
             
             # 清理源镜像
             docker rmi $SRC_IMAGE
             echo "✅ 双重同步完成！"
          else
             echo "💤 所有目标都已是最新，无需操作。"
          fi

      - name: 发送 Webhook 通知
        if: always()
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "未配置 WEBHOOK_URL，跳过通知。"
            exit 0
          fi

          JOB_STATUS="${{ job.status }}"
          REPO_NAME="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$JOB_STATUS" == "success" ]; then
             TITLE="✅ 双重同步成功"
          else
             TITLE="❌ 双重同步失败"
          fi

          PAYLOAD=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
              "text": "$TITLE\n仓库: $REPO_NAME\n状态: $JOB_STATUS\n链接: $RUN_URL"
            }
          }
          EOF
          )

          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL" || echo "发送失败"
