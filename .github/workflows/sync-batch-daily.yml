name: 01. æ‰¹é‡åŒæ­¥ (Batch Sync)

on:
  push:
    paths:
      - "images.txt"
  schedule:
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)"
        required: false
        type: boolean
        default: false

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  GHCR_REGISTRY: ghcr.io
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
  # æ˜ å°„ Secret åˆ° Env ä»¥ä¾› if åˆ¤æ–­
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: è¯»å–é…ç½® & æ£€æŸ¥ Secrets
        id: config
        run: |
          # è¯»å– config.env (å¦‚æœå­˜åœ¨)
          if [ -f "config.env" ]; then
             source config.env
             echo "CLEAN_DISK_SPACE=${CLEAN_DISK_SPACE}" >> $GITHUB_OUTPUT
             echo "SYNC_MODE=${SYNC_MODE}" >> $GITHUB_ENV
          else
             echo "CLEAN_DISK_SPACE=true" >> $GITHUB_OUTPUT
             echo "SYNC_MODE=none" >> $GITHUB_ENV
          fi

          if [ -z "${{ secrets.ALIYUN_USERNAME }}" ] || [ -z "${{ secrets.ALIYUN_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½® ALIYUN_USERNAME æˆ– ALIYUN_PASSWORD Secretsã€‚"
            exit 1
          fi

      - name: ğŸ—‘ï¸ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        if: steps.config.outputs.CLEAN_DISK_SPACE == 'true'
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          build-mount-path: "/var/lib/docker/"

      - name: é‡å¯ Docker æœåŠ¡
        run: sudo service docker restart

      # Secrets check moved to previous step


      - name: Checkout Code
        uses: actions/checkout@v3

      - name: ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ç™»å½• GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½• DockerHub
        if: env.DOCKERHUB_USER != ''
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¦ æ‰¹é‡å¤„ç†é•œåƒ
        run: |
          # å®šä¹‰é‡è¯•å‡½æ•°
          # å®šä¹‰é‡è¯•å‡½æ•°
          function retry {
            local n=1
            local max=3
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ å‘½ä»¤å¤±è´¥ï¼Œå¿è¯•ç¬¬ $n/$max æ¬¡é‡è¯•..." >&2
                  sleep $delay;
                else
                  echo "âŒ å‘½ä»¤åœ¨ $max æ¬¡å°è¯•åå¤±è´¥ã€‚" >&2
                  return 1
                fi
              }
            done
          }

          if [ ! -s "images.txt" ]; then
            echo "âš ï¸ images.txt ä¸å­˜åœ¨æˆ–ä¸ºç©ºã€‚"
            exit 0
          fi

          echo "ğŸ“‹ å¼€å§‹æ‰¹é‡å¤„ç†..."

          while IFS= read -r line || [ -n "$line" ]; do
            # å»é™¤é¦–å°¾ç©ºç™½
            line=$(echo "$line" | xargs)
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$line" || "$line" =~ ^# ]] && continue

            echo "----------------------------------------"
            echo "ğŸ”„ å¤„ç†æŒ‡ä»¤: $line"

            # 1. æå–é•œåƒåå’Œå‚æ•°
            # ç­–ç•¥: ç§»é™¤æ‰€æœ‰ä»¥æ­¤å¼€å¤´å‚æ•° --xxxx=val æˆ– --xxxx val
            # ä½†è¿™æ¯”è¾ƒå¤æ‚ã€‚ç®€å•ç­–ç•¥: 
            # å‡è®¾é•œåƒåä¸ä»¥æ­¤ -- å¼€å¤´ã€‚
            # æˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰å­—æ®µï¼Œæ‰¾åˆ°é‚£ä¸ªä¸æ˜¯å‚æ•°çš„å­—æ®µä½œä¸ºé•œåƒå?
            # æˆ–è€…ï¼Œæ›´ç®€å•: æå– --platform éƒ¨åˆ†ï¼Œå‰©ä¸‹çš„å¦‚æœæ˜¯ parameter flag åˆ™å¿½ç•¥ï¼Œå¦åˆ™å°±æ˜¯ image
            
            # Use regex to extract platform value anywhere in string
            PLATFORM_VAL=""
            if [[ "$line" =~ --platform[=\ ]([^ ]+) ]]; then
                 PLATFORM_VAL="${BASH_REMATCH[1]}"
            fi
            
            # Construct Platform Arg
            if [ -n "$PLATFORM_VAL" ]; then
                 PLATFORM_ARG="--platform $PLATFORM_VAL"
                 echo "âš™ï¸  æŒ‡å®šæ¶æ„: $PLATFORM_VAL"
                 if [[ "$PLATFORM_VAL" == *"/"* ]]; then
                    SKOPEO_OS=$(echo "$PLATFORM_VAL" | cut -d'/' -f1)
                    SKOPEO_ARCH=$(echo "$PLATFORM_VAL" | cut -d'/' -f2)
                 else
                    SKOPEO_ARCH="$PLATFORM_VAL"
                 fi
            fi
            
            SKOPEO_FLAGS="--override-os $SKOPEO_OS --override-arch $SKOPEO_ARCH"

            # æå–é•œåƒå: ç§»é™¤ --platform=xxx æˆ– --platform xxx
            # è¿™é‡Œçš„å¤„ç†æ–¹å¼:
            # 1. ç§»é™¤ --platform=xxx
            # 2. ç§»é™¤ --platform xxx
            # 3. Trim
            
            TEMP_LINE=$(echo "$line" | sed -E 's/--platform[= ]+[^ ]+ //g' | sed -E 's/ --platform[= ]+[^ ]+//g')
            SRC_IMAGE=$(echo "$TEMP_LINE" | xargs)
            
            # 2. å‘½åå¤„ç† (Smart Naming)
            # æå– Scope (namespace) å’Œ Basename
            # Logic: bitnami/redis -> Scope: bitnami, Base: redis
            #        redis -> Scope: "", Base: redis
            #        library/redis -> Scope: "", Base: redis
            
            SCOPE=""
            BASE_NAME=$(basename "$SRC_IMAGE" | cut -d':' -f1)
            TAG_NAME=$(echo "$SRC_IMAGE" | cut -d':' -f2 -s)
            [ -z "$TAG_NAME" ] && TAG_NAME="latest"
            
            # ç®€å•è§£æ namespace
            if [[ "$SRC_IMAGE" == *"/"* ]]; then
                NAMESPACE_PART=$(dirname "$SRC_IMAGE")
                if [[ "$NAMESPACE_PART" != "library" && "$NAMESPACE_PART" != "." ]]; then
                   SCOPE=$(basename "$NAMESPACE_PART")
                fi
            fi
            
            if [ -n "$SCOPE" ]; then
               TARGET_TAG="${SCOPE}_${BASE_NAME}:${TAG_NAME}"
            else
               TARGET_TAG="${BASE_NAME}:${TAG_NAME}"
            fi
            
            # å¤šæ¶æ„å‰ç¼€è¿½åŠ 
            if [ -n "$PLATFORM_VAL" ]; then
               PLATFORM_PREFIX=$(echo "$PLATFORM_VAL" | sed 's/\//_/g')
               TARGET_TAG="${PLATFORM_PREFIX}_${TARGET_TAG}"
            fi

            # 4. è¯»å–é…ç½®ä¸æ¨¡å¼åˆ¤å®š
            # ä½¿ç”¨ä¹‹å‰ ENV è®¾ç½®çš„ SYNC_MODE
            MODE="${SYNC_MODE:-none}"
            
            echo "Current Sync Mode: $MODE"
            
            if [ "$MODE" == "none" ]; then
                echo "ğŸ›‘ åŒæ­¥æ¨¡å¼ä¸º noneï¼Œè·³è¿‡æ‰€æœ‰æ“ä½œã€‚"
                continue
            fi

            ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$TARGET_TAG"
            
            # GHCR Target (Lowercase)
            OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            TAG_LOWER=$(echo "$TARGET_TAG" | tr '[:upper:]' '[:lower:]')
            GHCR_TARGET="$GHCR_REGISTRY/$OWNER_LOWER/$TAG_LOWER"

            # 5. æ‘˜è¦æ¯”å¯¹ (ä¸‰æ–¹)
            FORCE="${{ inputs.force_sync }}"
            PUSH_ALI=false
            PUSH_GHCR=false
            NEED_PULL=false
            
            # åˆå§‹åŒ–ç›®æ ‡æ ‡è®°
            CHECK_ALI=false
            CHECK_GHCR=false
            
            case "$MODE" in
                aliyun)
                    CHECK_ALI=true
                    ;;
                ghcr)
                    CHECK_GHCR=true
                    ;;
                double)
                    CHECK_ALI=true
                    CHECK_GHCR=true
                    ;;
                *)
                    echo "âš ï¸ æœªçŸ¥æ¨¡å¼ $MODEï¼Œé»˜è®¤è·³è¿‡ã€‚"
                    continue
                    ;;
            esac

            if [ "$FORCE" != "true" ]; then
               echo "ğŸ” æ¯”å¯¹ Digest & Created ($SKOPEO_ARCH) [Mode: $MODE]..."
               
               # æºä¿¡æ¯
               SRC_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$SRC_IMAGE" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
               SRC_DIGEST=$(echo "$SRC_INFO" | cut -d'|' -f1)
               SRC_CREATED=$(echo "$SRC_INFO" | cut -d'|' -f2)
               
               if [ -z "$SRC_DIGEST" ]; then
                   echo "âš ï¸ æ— æ³•è·å–æºé•œåƒä¿¡æ¯ï¼Œè·³è¿‡ã€‚"
                   continue
               fi

               # 1. Check Aliyun
               if [ "$CHECK_ALI" == "true" ]; then
                   ALI_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$ALI_TARGET" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
                   ALI_DIGEST=$(echo "$ALI_INFO" | cut -d'|' -f1)
                   ALI_CREATED=$(echo "$ALI_INFO" | cut -d'|' -f2)
                   
                   if [ "$SRC_DIGEST" == "$ALI_DIGEST" ]; then
                       echo "âœ… [Aliyun] æ‘˜è¦ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
                   elif [ -n "$ALI_DIGEST" ] && [ "$SRC_CREATED" == "$ALI_CREATED" ]; then
                       echo "âš ï¸ [Aliyun] æ‘˜è¦ä¸åŒä½†åˆ›å»ºæ—¶é—´ä¸€è‡´ï¼Œåˆ¤å®šä¸ºåŒæºï¼Œè·³è¿‡ã€‚"
                   else
                       echo "ğŸš€ [Aliyun] éœ€æ›´æ–°"
                       PUSH_ALI=true
                   fi
               fi

               # 2. Check GHCR
               if [ "$CHECK_GHCR" == "true" ]; then
                   GHCR_INFO=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$GHCR_TARGET" --format='{{.Digest}}|{{.Created}}' 2>/dev/null || echo "")
                   GHCR_DIGEST=$(echo "$GHCR_INFO" | cut -d'|' -f1)
                   GHCR_CREATED=$(echo "$GHCR_INFO" | cut -d'|' -f2)

                   if [ "$SRC_DIGEST" == "$GHCR_DIGEST" ]; then
                       echo "âœ… [GHCR] æ‘˜è¦ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
                   elif [ -n "$GHCR_DIGEST" ] && [ "$SRC_CREATED" == "$GHCR_CREATED" ]; then
                       echo "âš ï¸ [GHCR] æ‘˜è¦ä¸åŒä½†åˆ›å»ºæ—¶é—´ä¸€è‡´ï¼Œåˆ¤å®šä¸ºåŒæºï¼Œè·³è¿‡ã€‚"
                   else
                       echo "ğŸš€ [GHCR] éœ€æ›´æ–°"
                       PUSH_GHCR=true
                   fi
               fi
            else
               echo "âš ï¸ å¼ºåˆ¶æ¨¡å¼ï¼Œè·³è¿‡æ¯”å¯¹ã€‚"
               [ "$CHECK_ALI" == "true" ] && PUSH_ALI=true
               [ "$CHECK_GHCR" == "true" ] && PUSH_GHCR=true
            fi

            # æ±‡æ€»æ‹‰å–éœ€æ±‚
            if [ "$PUSH_ALI" == "true" ] || [ "$PUSH_GHCR" == "true" ]; then
                NEED_PULL=true
            fi

            # 6. æ‰§è¡ŒåŒæ­¥
            if [ "$NEED_PULL" == "true" ]; then
               echo "ğŸ“¥ æ‹‰å– $SRC_IMAGE ..."
               retry docker pull $SRC_IMAGE $PLATFORM_ARG
               
               # æ¨é€ Aliyun
               if [ "$PUSH_ALI" == "true" ]; then
                   echo "ğŸ·ï¸ -> é˜¿é‡Œäº‘ $ALI_TARGET"
                   docker tag "$SRC_IMAGE" "$ALI_TARGET"
                   retry docker push "$ALI_TARGET"
                   docker rmi "$ALI_TARGET" >/dev/null 2>&1 || true
               fi
               
               # æ¨é€ GHCR
               if [ "$PUSH_GHCR" == "true" ]; then
                   echo "ğŸ·ï¸ -> GHCR $GHCR_TARGET"
                   docker tag "$SRC_IMAGE" "$GHCR_TARGET"
                   retry docker push "$GHCR_TARGET"
                   docker rmi "$GHCR_TARGET" >/dev/null 2>&1 || true
               fi
               
               echo "ğŸ§¹ æ¸…ç†æºé•œåƒ..."
               docker rmi "$SRC_IMAGE" >/dev/null 2>&1 || true
            else
               echo "ğŸ’¤ æ— éœ€æ›´æ–°ã€‚"
            fi
            
            # ç®€å•ç›‘æ§
            echo "ç£ç›˜ç©ºé—´:"
            df -h | grep "/var/lib/docker" | awk '{print $4 " available"}' || true

          done < images.txt

      - name: æ›´æ–° README Badge
        run: |
          # è·å–å½“å‰ UTC+8 æ—¶é—´
          DATE=$(TZ='Asia/Shanghai' date +'%Y--%m--%d %H:%M:%S')
          # URL Encode (space -> %20)
          ENC_DATE=${DATE// /%20}

          # æ„é€ æ–°çš„ badge é“¾æ¥
          NEW_BADGE="https://img.shields.io/badge/last%20sync-$ENC_DATE-green"

          # æ›¿æ¢ README ä¸­çš„ badge
          # åŒ¹é…æ¨¡å¼: ![Last Sync](https://img.shields.io/badge/.*)
          sed -i "s|!\[Last Sync\](.*)|![Last Sync]($NEW_BADGE)|g" README.md

          # æäº¤æ›´æ”¹
          if [[ -n $(git status -s) ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git commit -am "docs: update last sync badge [skip ci]"
            git push
          else
             echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤ã€‚"
          fi

      - name: å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "æœªé…ç½® WEBHOOK_URLï¼Œè·³è¿‡é€šçŸ¥ã€‚"
            exit 0
          fi

          JOB_STATUS="${{ job.status }}"
          REPO_NAME="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$JOB_STATUS" == "success" ]; then
             COLOR="info"
             TITLE="âœ… æ‰¹é‡åŒæ­¥æˆåŠŸ"
          else
             COLOR="warning"
             TITLE="âŒ æ‰¹é‡åŒæ­¥å¤±è´¥"
          fi

          # æ„é€ ç®€å• JSON (é€‚é…å¸¸è§çš„é’‰é’‰/é£ä¹¦/Discord/Slack)
          # è¿™é‡Œé‡‡ç”¨é€šç”¨ JSON ç»“æ„ï¼Œå¯è§†éœ€è¦è°ƒæ•´

          PAYLOAD=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
              "text": "$TITLE\nä»“åº“: $REPO_NAME\nçŠ¶æ€: $JOB_STATUS\né“¾æ¥: $RUN_URL"
            }
          }
          EOF
          )

          echo "å‘é€é€šçŸ¥..."
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL" || echo "å‘é€å¤±è´¥"
